<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DuckWeb - Загрузка файлов</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/bs4/dt-1.10.21/datatables.min.css"/>
  <!-- Исправлена ссылка на Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* Стили из оригинального файла */
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 1rem 0;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .header-content {
      max-width: 1400px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 20px;
    }
    
    .logo {
      font-size: 2rem;
      font-weight: bold;
      margin: 0;
    }
    
    .header-buttons {
      display: flex;
      gap: 15px;
    }
    
    .header-button {
      padding: 10px 20px;
      border-radius: 25px;
      font-weight: 500;
      transition: all 0.3s ease;
    }
    
    .header-button-back {
      background: rgba(255,255,255,0.2);
      border: 2px solid transparent;
      color: white;
    }
    
    .header-button-back:hover {
      background: rgba(255,255,255,0.3);
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    
    /* Стили для комнат и компьютеров */
    .rooms-section {
      max-width: 1400px;
      margin: 30px auto;
      padding: 0 20px;
    }

    .rooms-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .rooms-title {
      color: #333;
      font-size: 1.5rem;
      font-weight: 600;
    }

    .rooms-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .room-card {
      background: white;
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 3px 15px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
    }

    .room-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 5px 20px rgba(0,0,0,0.15);
    }

    .room-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid #f0f0f0;
    }

    .room-name {
      font-size: 1.3rem;
      font-weight: 600;
      color: #333;
      margin: 0;
    }

    .room-code {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 0.9rem;
      font-weight: 500;
    }

    .computers-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .computer-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      background: #f8f9fa;
      border-radius: 10px;
      transition: all 0.2s ease;
      cursor: pointer;
    }

    .computer-item:hover {
      background: #e9ecef;
    }

    .computer-item.selected {
      background: #e3f2fd;
      border: 2px solid #667eea;
    }

    .computer-info {
      display: flex;
      align-items: center;
      gap: 10px;
      flex: 1;
    }

    .computer-checkbox {
      width: 18px;
      height: 18px;
      border-radius: 3px;
      border: 2px solid #667eea;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      flex-shrink: 0;
    }

    .computer-checkbox.checked {
      background: #667eea;
    }

    .computer-checkbox.checked::after {
      content: '✓';
      color: white;
      font-size: 12px;
      font-weight: bold;
    }

    .computer-checkbox.disabled {
      border-color: #6c757d;
      background: #e9ecef;
      cursor: not-allowed;
    }

    .computer-name {
      font-weight: 500;
    }

    .computer-status {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .status-online {
      background-color: #28a745;
    }

    .status-offline {
      background-color: #dc3545;
    }

    .section-divider {
      height: 2px;
      background: linear-gradient(90deg, transparent, #667eea, transparent);
      margin: 40px 0;
    }

    /* Стили для готовых приложений */
    .apps-section {
      max-width: 1400px;
      margin: 30px auto;
      padding: 0 20px;
    }

    .apps-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .apps-title {
      color: #333;
      font-size: 1.5rem;
      font-weight: 600;
    }

    .apps-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
    }

    .app-card {
      background: white;
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 3px 15px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
      border: 2px solid transparent;
      cursor: pointer;
    }

    .app-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 20px rgba(0,0,0,0.15);
    }

    .app-card.selected {
      border-color: #667eea;
      background-color: #f0f4ff;
    }

    .app-header {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 15px;
    }

    .app-icon {
      width: 50px;
      height: 50px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 1.5rem;
    }

    .app-info {
      flex: 1;
    }

    .app-name {
      font-size: 1.2rem;
      font-weight: 600;
      color: #333;
      margin: 0;
    }

    .app-version {
      font-size: 0.8rem;
      color: #6c757d;
    }

    .app-description {
      font-size: 0.9rem;
      color: #495057;
      margin-bottom: 15px;
      line-height: 1.4;
    }

    .app-details {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      font-size: 0.8rem;
      color: #6c757d;
    }

    .app-size {
      font-weight: 500;
    }

    .app-checkbox {
      width: 20px;
      height: 20px;
      border-radius: 4px;
      border: 2px solid #667eea;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      flex-shrink: 0;
    }

    .app-checkbox.checked {
      background: #667eea;
    }

    .app-checkbox.checked::after {
      content: '✓';
      color: white;
      font-size: 12px;
      font-weight: bold;
    }

    .app-download-btn {
      width: 100%;
      padding: 10px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 10px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .app-download-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }

    /* Обновленные стили для кнопок управления */
    .control-btn {
      padding: 10px 20px;
      border-radius: 12px;
      font-weight: 600;
      font-size: 0.9rem;
      transition: all 0.3s ease;
      border: 2px solid transparent;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .control-btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
    }

    .control-btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
      background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
    }

    .control-btn-outline {
      background: white;
      color: #667eea;
      border: 2px solid #667eea;
    }

    .control-btn-outline:hover {
      background: #667eea;
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
    }

    .control-btn-refresh {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
    }

    .control-btn-refresh:hover {
      background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
    }

    .rooms-controls {
      display: flex;
      gap: 12px;
    }

    .apps-controls {
      display: flex;
      gap: 12px;
    }

    /* Большая кнопка внизу экрана */
    .download-all-section {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      padding: 20px;
      box-shadow: 0 -2px 20px rgba(0,0,0,0.1);
      z-index: 1000;
    }

    .download-all-btn {
      width: 100%;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 15px;
      font-size: 1.3rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
    }

    .download-all-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 25px rgba(102, 126, 234, 0.5);
    }

    .download-all-btn:disabled {
      background: #6c757d;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    body {
      background-color: #f8f9fa;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding-bottom: 100px; /* Отступ для фиксированной кнопки */
    }

    .empty-message {
      text-align: center;
      padding: 40px;
      color: #6c757d;
    }

    .selected-count {
      background: #667eea;
      color: white;
      padding: 4px 12px;
      border-radius: 15px;
      font-size: 0.9rem;
      font-weight: 500;
      margin-left: 10px;
    }

    .section-title {
      color: #333;
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-content">
      <h1 class="logo">DuckWeb - Загрузка файлов</h1>
      <div class="header-buttons">
        <button class="btn header-button header-button-back" id="backBtn">
          <i class="fas fa-arrow-left"></i>
          Назад к мониторингу
        </button>
      </div>
    </div>
  </header>

  <!-- Секция комнат -->
  <div class="rooms-section">
    <div class="rooms-header">
      <h2 class="section-title">
        Выберите компьютеры для загрузки
        <span class="selected-count" id="selectedCount">0</span>
      </h2>
      <div class="rooms-controls">
        <button class="control-btn control-btn-outline" id="selectAllBtn">
          <i class="fas fa-check-double"></i> Выбрать все
        </button>
        <button class="control-btn control-btn-refresh" id="refreshRooms">
          <i class="fas fa-sync-alt"></i> Обновить
        </button>
      </div>
    </div>
    
    <div class="rooms-grid" id="roomsGrid">
      <!-- Комнаты будут добавляться динамически -->
    </div>
  </div>

  <div class="section-divider"></div>

  <!-- Секция готовых приложений -->
  <div class="apps-section">
    <div class="apps-header">
      <h2 class="apps-title">Готовые приложения для загрузки</h2>
      <div class="apps-controls">
        <button class="control-btn control-btn-primary" id="selectAllAppsBtn">
          <i class="fas fa-check-double"></i> Выбрать все приложения
        </button>
      </div>
    </div>
    
    <div class="apps-grid" id="appsGrid">
      <!-- Приложения будут добавляться динамически -->
    </div>
  </div>

  <!-- Большая кнопка внизу экрана -->
  <div class="download-all-section">
    <button class="download-all-btn" id="downloadAllBtn" disabled>
      <i class="fas fa-download"></i> Скачать <span id="selectedFilesCount">0</span> файлов на <span id="selectedComputersCount">0</span> выбранных компьютеров
    </button>
  </div>

  <!-- Исправлен порядок подключения скриптов -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
  <script type="text/javascript" src="https://cdn.datatables.net/v/bs4/dt-1.10.21/datatables.min.js"></script>
  
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Элементы DOM
      const roomsGrid = document.getElementById('roomsGrid');
      const appsGrid = document.getElementById('appsGrid');
      const selectAllBtn = document.getElementById('selectAllBtn');
      const selectAllAppsBtn = document.getElementById('selectAllAppsBtn');
      const backBtn = document.getElementById('backBtn');
      const refreshRoomsBtn = document.getElementById('refreshRooms');
      const selectedCount = document.getElementById('selectedCount');
      const downloadAllBtn = document.getElementById('downloadAllBtn');
      const selectedFilesCount = document.getElementById('selectedFilesCount');
      const selectedComputersCount = document.getElementById('selectedComputersCount');
      
      // Обработчик кнопки Назад
      backBtn.addEventListener('click', function() {
        // Возврат на страницу мониторинга
        window.location.href = './';
      });
      
      // Данные приложения
      let roomsData = [];
      let readyApps = [];

      // Загружаем комнаты
      fetch('rooms.json')
        .then(response => {
          if (!response.ok) throw new Error('Ошибка загрузки rooms.json');
          return response.json();
        })
        .then(data => {
          roomsData = data; // теперь data — это массив комнат напрямую
          renderRooms();
          updateSelectedCount();
          updateDownloadAllButton();
        })
        .catch(err => {
          console.error('Ошибка загрузки rooms.json:', err);
          alert('Не удалось загрузить данные комнат');
        });

      // Загружаем приложения
      fetch('apps.json')
        .then(response => {
          if (!response.ok) throw new Error('Ошибка загрузки apps.json');
          return response.json();
        })
        .then(data => {
          readyApps = data; // теперь data — это массив приложений напрямую
          renderApps();
          updateDownloadAllButton();
        })
        .catch(err => {
          console.error('Ошибка загрузки apps.json:', err);
          alert('Не удалось загрузить данные приложений');
        });




      
      // Инициализация приложения
      function initApp() {
        renderRooms();
        renderApps();
        updateSelectedCount();
        updateDownloadAllButton();
        
        // Обработчик выбора всех компьютеров
        selectAllBtn.addEventListener('click', function() {
          const allOnlineComputers = getAllOnlineComputers();
          const currentlySelected = getSelectedComputers().length;
          const allSelected = currentlySelected === allOnlineComputers.length;
          
          roomsData.forEach(room => {
            room.computers.forEach(computer => {
              if (computer.online) {
                computer.selected = !allSelected;
              }
            });
          });
          
          renderRooms();
          updateSelectedCount();
          updateDownloadAllButton();
        });

        
        // Обработчик выбора всех приложений
        selectAllAppsBtn.addEventListener('click', function() {
          const currentlySelected = getSelectedApps().length;
          const allSelected = currentlySelected === readyApps.length;
          
          readyApps.forEach(app => {
            app.selected = !allSelected;
          });
          
          renderApps();
          updateDownloadAllButton();
        });

        
        // Обработчик обновления комнат
        refreshRoomsBtn.addEventListener('click', function() {
          // Имитируем обновление статусов компьютеров
          roomsData.forEach(room => {
            room.computers.forEach(computer => {
              if (Math.random() > 0.7) {
                computer.online = !computer.online;
                if (!computer.online) {
                  computer.selected = false;
                }
              }
            });
          });
          renderRooms();
          updateSelectedCount();
          updateDownloadAllButton();
          alert('Статусы компьютеров обновлены!');
        });

        // Обработчик кнопки "Скачать файлы на выбранные компьютеры" с сохранением selected.json на сервер
        downloadAllBtn.addEventListener('click', function() {
          const selectedComputers = getSelectedComputers();
          const selectedApps = getSelectedApps();

          if (selectedComputers.length === 0) {
            alert('Пожалуйста, выберите хотя бы один компьютер для загрузки.');
            return;
          }

          if (selectedApps.length === 0) {
            alert('Пожалуйста, выберите хотя бы одно приложение для скачивания.');
            return;
          }

          const selectedData = {
            computers: selectedComputers.map(c => ({ id: c.id, name: c.name, roomId: c.roomId })),
            apps: selectedApps.map(a => ({ id: a.id, name: a.name, version: a.version }))
          };

          fetch('save_selected', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(selectedData)
          })
          .then(response => {
            if (!response.ok) throw new Error('Ошибка при сохранении selected.json');
            return response.json();
          })
          .then(data => {
            alert(data.message || 'Выбор сохранён в selected.json');

            // Сбрасываем выбор
            roomsData.forEach(room => room.computers.forEach(c => c.selected = false));
            readyApps.forEach(a => a.selected = false);

            renderRooms();
            renderApps();
            updateSelectedCount();
            updateDownloadAllButton();
          })
          .catch(err => {
            console.error(err);
            alert('Не удалось сохранить выбранные файлы.');
          });
        });


      }
      
      // Функция отрисовки комнат
      function renderRooms() {
        if (roomsData.length === 0) {
          roomsGrid.innerHTML = `
            <div class="empty-message">
              <i class="fas fa-door-closed fa-2x mb-3"></i><br>
              У вас нет комнат
            </div>
          `;
          return;
        }

        roomsGrid.innerHTML = roomsData.map(room => `
          <div class="room-card">
            <div class="room-header">
              <h3 class="room-name">${room.name}</h3>
              <div class="room-code">${room.code}</div>
            </div>
            <div class="computers-list">
              ${room.computers.map(computer => {
                const isOnline = computer.online ?? (computer.status === 'online'); // если online нет, проверяем status
                const isSelected = computer.selected && isOnline;
                return `
                <div class="computer-item ${isSelected ? 'selected' : ''}" 
                    data-computer-id="${computer.id}"
                    data-room-id="${room.id}">
                  <div class="computer-info">
                    <div class="computer-checkbox ${isSelected ? 'checked' : ''} ${!isOnline ? 'disabled' : ''}">
                    </div>
                    <div class="computer-status ${isOnline ? 'status-online' : 'status-offline'}"></div>
                    <span class="computer-name">${computer.name}</span>
                  </div>
                </div>
                `;
              }).join('')}

            </div>
          </div>
        `).join('');

        // Добавляем обработчики кликов для всей области компьютера
        roomsGrid.querySelectorAll('.computer-item').forEach(item => {
          item.addEventListener('click', function() {
            const computerId = parseInt(this.dataset.computerId);
            const roomId = parseInt(this.dataset.roomId);
            const room = roomsData.find(r => r.id === roomId);
            if (room) {
              const computer = room.computers.find(c => c.id === computerId);
              const isOnline = computer.online ?? (computer.status === 'online');
              if (computer && isOnline) {
                computer.selected = !computer.selected;
                this.classList.toggle('selected');
                const checkbox = this.querySelector('.computer-checkbox');
                if (checkbox) checkbox.classList.toggle('checked');
                updateSelectedCount();
                updateDownloadAllButton(); // обновляем кнопку
              }
            }
          });
        });

      }

      
      // Функция отрисовки готовых приложений
      function renderApps() {
        appsGrid.innerHTML = readyApps.map(app => `
          <div class="app-card ${app.selected ? 'selected' : ''}" data-app-id="${app.id}">
            <div class="app-header">
              <div class="app-icon">
                <i class="${app.icon}"></i>
              </div>
              <div class="app-info">
                <h4 class="app-name">${app.name}</h4>
                <div class="app-version">Версия ${app.version}</div>
              </div>
              <div class="app-checkbox ${app.selected ? 'checked' : ''}">
              </div>
            </div>
            <div class="app-description">
              ${app.description}
            </div>
            <div class="app-details">
              <span class="app-size">${app.size}</span>
            </div>
            <button class="app-download-btn" data-app-name="${app.name}">
              <i class="fas fa-download"></i> Скачать
            </button>
          </div>
        `).join('');
        
        // Добавляем обработчики кликов для всей карточки приложения
        appsGrid.querySelectorAll('.app-card').forEach(card => {
          card.addEventListener('click', function(e) {
            // Проверяем, не кликнули ли по кнопке скачивания или чекбоксу
            if (!e.target.classList.contains('app-download-btn') && 
                !e.target.classList.contains('app-checkbox')) {
              const appId = parseInt(this.dataset.appId);
              const app = readyApps.find(a => a.id === appId);
              if (app) {
                app.selected = !app.selected;
                this.classList.toggle('selected');
                const checkbox = this.querySelector('.app-checkbox');
                checkbox.classList.toggle('checked');
                updateDownloadAllButton();
              }
            }
          });
        });
        
        // Добавляем обработчики для кнопок скачивания отдельных приложений
        appsGrid.querySelectorAll('.app-download-btn').forEach(button => {
          button.addEventListener('click', function(e) {
            e.stopPropagation(); // Останавливаем всплытие, чтобы не сработал клик по карточке
            const appName = this.dataset.appName;
            downloadSingleApp(appName);
          });
        });
      }
      
      // Функция обновления счетчика выбранных компьютеров
      function updateSelectedCount() {
        const selectedComputers = getSelectedComputers();
        selectedCount.textContent = selectedComputers.length;
      }
      
      // Функция обновления состояния кнопки скачивания всех файлов
      function updateDownloadAllButton() {
        const selectedComputers = getSelectedComputers();
        const selectedApps = getSelectedApps();
        const hasSelectedComputers = selectedComputers.length > 0;
        const hasSelectedApps = selectedApps.length > 0;
        
        downloadAllBtn.disabled = !hasSelectedComputers || !hasSelectedApps;
        selectedFilesCount.textContent = selectedApps.length;
        selectedComputersCount.textContent = selectedComputers.length;
        
        if (hasSelectedComputers && hasSelectedApps) {
          downloadAllBtn.innerHTML = `<i class="fas fa-download"></i> Скачать ${selectedApps.length} файлов на ${selectedComputers.length} выбранных компьютеров`;
        } else {
          downloadAllBtn.innerHTML = `<i class="fas fa-download"></i> Скачать файлы на выбранные компьютеры`;
        }
      }
      
      // Получить список выбранных компьютеров
      function getSelectedComputers() {
        return roomsData.flatMap(room => 
          room.computers.filter(computer => computer.selected && (computer.online ?? computer.status === 'online'))
        );
      }
      
      // Получить список выбранных приложений
      function getSelectedApps() {
        return readyApps.filter(app => app.selected);
      }
      
      // Получить все онлайн компьютеры
      function getAllOnlineComputers() {
        return roomsData.flatMap(room => 
          room.computers.filter(computer => computer.online ?? computer.status === 'online')
        );
      }
      
      // Функция для скачивания одного приложения
      function downloadSingleApp(appName) {
        const app = readyApps.find(a => a.name === appName);
        if (app) {
          alert(`Начинается скачивание приложения: ${app.name} ${app.version}\nРазмер: ${app.size}`);
          // В реальном приложении здесь был бы редирект на скачивание
        }
      }
      
      // Инициализация приложения
      initApp();
    });
  </script>
</body>
</html>